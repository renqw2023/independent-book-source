name: è‡ªåŠ¨ç”Ÿæˆä¹¦æºæ–‡ä»¶

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  generate-sources:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp beautifulsoup4 lxml requests jsonpath-ng
        # å°è¯•å®‰è£…å¯é€‰ä¾èµ–ï¼Œå¤±è´¥ä¹Ÿä¸å½±å“
        pip install js2py || echo "js2pyå®‰è£…å¤±è´¥ï¼ŒJavaScriptåŠŸèƒ½å°†è¢«ç¦ç”¨"
        pip install html5lib pyquery || echo "å¯é€‰ä¾èµ–å®‰è£…å¤±è´¥"
    
    - name: ç”Ÿæˆä¹¦æºæ–‡ä»¶
      run: |
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p output/individual

        # ç”Ÿæˆæ‰€æœ‰ä¹¦æº
        echo "å¼€å§‹ç”Ÿæˆä¹¦æºæ–‡ä»¶..."
        if python src/main.py --generate-all --output output; then
          echo "âœ… ä¹¦æºç”ŸæˆæˆåŠŸ"
        else
          echo "âš ï¸ ä¸»ç”Ÿæˆå¤±è´¥ï¼Œå°è¯•ç”Ÿæˆç•ªèŒ„å°è¯´..."
          python src/main.py --generate fanqie --output output || echo "âŒ ç•ªèŒ„å°è¯´ç”Ÿæˆä¹Ÿå¤±è´¥"
        fi

        # ç”Ÿæˆå•ç‹¬çš„ä¹¦æºæ–‡ä»¶
        echo "ç”Ÿæˆå•ç‹¬ä¹¦æºæ–‡ä»¶..."
        python src/main.py --generate fanqie --output output/individual || echo "âš ï¸ å•ç‹¬ç”Ÿæˆå¤±è´¥"

        # åˆ›å»ºä¹¦æºä¿¡æ¯æ–‡ä»¶
        echo "ç”Ÿæˆæ—¶é—´: $(date)" > output/build_info.txt
        echo "æäº¤å“ˆå¸Œ: ${{ github.sha }}" >> output/build_info.txt
        echo "åˆ†æ”¯: ${{ github.ref_name }}" >> output/build_info.txt

        # æ˜¾ç¤ºç”Ÿæˆç»“æœ
        echo "=== ç”Ÿæˆç»“æœ ==="
        ls -la output/ || echo "è¾“å‡ºç›®å½•ä¸ºç©º"
    
    - name: éªŒè¯ä¹¦æºæ–‡ä»¶
      run: |
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        ls -la output/ || echo "è¾“å‡ºç›®å½•ä¸å­˜åœ¨"

        # éªŒè¯JSONæ ¼å¼ï¼ˆå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼‰
        if [ -f "output/legado_sources.json" ]; then
          python -c "import json; json.load(open('output/legado_sources.json')); print('âœ… ä¹¦æºæ–‡ä»¶æ ¼å¼æ­£ç¡®')" || echo "JSONæ ¼å¼éªŒè¯å¤±è´¥"
          python -c "import json; data=json.load(open('output/legado_sources.json')); print(f'ğŸ“š ç”Ÿæˆäº† {len(data)} ä¸ªä¹¦æº')" || echo "ä¹¦æºæ•°é‡ç»Ÿè®¡å¤±è´¥"
        else
          echo "âš ï¸ ä¸»ä¹¦æºæ–‡ä»¶ä¸å­˜åœ¨"
        fi
    
    - name: æäº¤ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
        git add output/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          git commit -m "ğŸ¤– è‡ªåŠ¨ç”Ÿæˆä¹¦æºæ–‡ä»¶ $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        fi
    
    - name: åˆ›å»ºReleaseï¼ˆä»…åœ¨ä¸»åˆ†æ”¯ï¼‰
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: ä¹¦æºæ–‡ä»¶ v${{ github.run_number }}
        body: |
          ## ğŸ“š è‡ªåŠ¨ç”Ÿæˆçš„ä¹¦æºæ–‡ä»¶
          
          **ç”Ÿæˆæ—¶é—´**: ${{ steps.date.outputs.date }}
          **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          
          ### ğŸ“¥ å¯¼å…¥æ–¹å¼
          
          #### æ–¹å¼1: ç›´æ¥é“¾æ¥å¯¼å…¥ï¼ˆæ¨èï¼‰
          ```
          https://raw.githubusercontent.com/${{ github.repository }}/main/output/legado_sources.json
          ```
          
          #### æ–¹å¼2: ä¸‹è½½æ–‡ä»¶å¯¼å…¥
          ä¸‹è½½ `legado_sources.json` æ–‡ä»¶ï¼Œç„¶ååœ¨legadoä¸­å¯¼å…¥
          
          ### ğŸ“‹ åŒ…å«çš„ä¹¦æº
          - ğŸ… ç•ªèŒ„å°è¯´ï¼ˆå…è´¹ï¼‰
          
          ### ğŸ”„ æ›´æ–°è¯´æ˜
          - ä¹¦æºæ–‡ä»¶æ¯å¤©è‡ªåŠ¨æ›´æ–°
          - å¦‚æœ‰é—®é¢˜è¯·æäº¤Issue
          
        files: |
          output/legado_sources.json
          output/individual/*.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
