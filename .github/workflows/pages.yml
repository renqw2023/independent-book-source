name: éƒ¨ç½²GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp beautifulsoup4 lxml requests jsonpath-ng
      
      - name: ç”Ÿæˆä¹¦æºæ–‡ä»¶
        run: |
          echo "å¼€å§‹ç”Ÿæˆä¹¦æºæ–‡ä»¶..."
          mkdir -p docs/sources/individual

          # ç”Ÿæˆæ‰€æœ‰ä¹¦æºåˆ°docs/sourcesç›®å½•
          if python src/main.py --generate-all --output docs/sources; then
            echo "âœ… ä¸»ä¹¦æºæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          else
            echo "âš ï¸ ä¸»ç”Ÿæˆå¤±è´¥ï¼Œå°è¯•ç”Ÿæˆç•ªèŒ„å°è¯´..."
            python src/main.py --generate fanqie --output docs/sources || echo "âŒ ç•ªèŒ„å°è¯´ç”Ÿæˆå¤±è´¥"
          fi

          # ç”Ÿæˆå„ä¸ªä¹¦æºçš„å•ç‹¬æ–‡ä»¶
          echo "ç”Ÿæˆå•ç‹¬ä¹¦æºæ–‡ä»¶..."
          for source in fanqie; do
            if python src/main.py --generate $source --output docs/sources/individual; then
              # é‡å‘½åæ–‡ä»¶
              if [ -f "docs/sources/individual/legado_sources_$source.json" ]; then
                mv "docs/sources/individual/legado_sources_$source.json" "docs/sources/individual/$source.json"
                echo "âœ… $source.json ç”ŸæˆæˆåŠŸ"
              fi
            else
              echo "âš ï¸ $source å•ç‹¬ç”Ÿæˆå¤±è´¥"
            fi
          done

          # æ˜¾ç¤ºç”Ÿæˆç»“æœ
          echo "=== ç”Ÿæˆç»“æœ ==="
          ls -la docs/sources/ || echo "docs/sourcesç›®å½•ä¸ºç©º"
          ls -la docs/sources/individual/ || echo "individualç›®å½•ä¸ºç©º"
      
      - name: åˆ›å»ºç½‘ç«™é¦–é¡µ
        run: |
          cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ç‹¬ç«‹ä¹¦æºç³»ç»Ÿ - å¤§ç°ç‹¼èåˆä¹¦æºç‹¬ç«‹ç‰ˆ</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
                  .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  h1 { color: #333; text-align: center; margin-bottom: 30px; }
                  .source-card { background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #007bff; }
                  .source-name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 10px; }
                  .source-url { font-family: monospace; background: #e9ecef; padding: 8px; border-radius: 4px; word-break: break-all; margin: 10px 0; }
                  .copy-btn { background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
                  .copy-btn:hover { background: #0056b3; }
                  .footer { text-align: center; margin-top: 30px; color: #666; }
                  .update-time { text-align: center; color: #888; margin-bottom: 20px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ… ç‹¬ç«‹ä¹¦æºç³»ç»Ÿ</h1>
                  <div class="update-time">æœ€åæ›´æ–°: <span id="updateTime"></span></div>
                  
                  <div class="source-card">
                      <div class="source-name">ğŸ“š å…¨éƒ¨ä¹¦æºï¼ˆæ¨èï¼‰</div>
                      <div>åŒ…å«æ‰€æœ‰å¯ç”¨çš„ä¹¦æºï¼Œä¸€æ¬¡å¯¼å…¥å³å¯ä½¿ç”¨å…¨éƒ¨åŠŸèƒ½</div>
                      <div class="source-url" id="allSources">
                          https://raw.githubusercontent.com/renqw2023/independent-book-source/main/docs/sources/legado_sources.json
                      </div>
                      <button class="copy-btn" onclick="copyToClipboard('allSources')">å¤åˆ¶é“¾æ¥</button>
                  </div>
                  
                  <div class="source-card">
                      <div class="source-name">ğŸ… ç•ªèŒ„å°è¯´</div>
                      <div>å­—èŠ‚è·³åŠ¨æ——ä¸‹å…è´¹å°è¯´å¹³å°ï¼Œæµ·é‡å…è´¹èµ„æº</div>
                      <div class="source-url" id="fanqie">
                          https://raw.githubusercontent.com/renqw2023/independent-book-source/main/docs/sources/individual/fanqie.json
                      </div>
                      <button class="copy-btn" onclick="copyToClipboard('fanqie')">å¤åˆ¶é“¾æ¥</button>
                  </div>
                  
                  <h2>ğŸ“¥ ä½¿ç”¨æ–¹æ³•</h2>
                  <ol>
                      <li>å¤åˆ¶ä¸Šé¢çš„ä¹¦æºé“¾æ¥</li>
                      <li>æ‰“å¼€legadoé˜…è¯»è½¯ä»¶</li>
                      <li>è¿›å…¥"ä¹¦æºç®¡ç†"</li>
                      <li>ç‚¹å‡»"ç½‘ç»œå¯¼å…¥"</li>
                      <li>ç²˜è´´é“¾æ¥å¹¶å¯¼å…¥</li>
                  </ol>
                  
                  <h2>âœ¨ ç‰¹ç‚¹</h2>
                  <ul>
                      <li>âœ… å®Œå…¨å…è´¹ï¼Œæ— éœ€ç™»å½•</li>
                      <li>âœ… è‡ªåŠ¨æ›´æ–°ï¼Œä¿æŒæœ€æ–°</li>
                      <li>âœ… å¼€æºé€æ˜ï¼Œå®‰å…¨å¯é </li>
                      <li>âœ… å…¼å®¹legadoï¼Œå³æ’å³ç”¨</li>
                  </ul>
                  
                  <div class="footer">
                      <p>ğŸ“– <a href="https://github.com/renqw2023/independent-book-source">GitHubé¡¹ç›®åœ°å€</a></p>
                      <p>â­ å¦‚æœè§‰å¾—æœ‰ç”¨ï¼Œè¯·ç»™ä¸ªStaræ”¯æŒä¸€ä¸‹ï¼</p>
                  </div>
              </div>
              
              <script>
                  function copyToClipboard(elementId) {
                      const element = document.getElementById(elementId);
                      const text = element.textContent.trim();
                      navigator.clipboard.writeText(text).then(() => {
                          alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                      });
                  }
                  
                  // æ˜¾ç¤ºæ›´æ–°æ—¶é—´
                  document.getElementById('updateTime').textContent = new Date().toLocaleString('zh-CN');
              </script>
          </body>
          </html>
          EOF
      
      - name: è®¾ç½®Pages
        uses: actions/configure-pages@v4

      - name: ä¸Šä¼ Pagesæ–‡ä»¶
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'
  
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: éƒ¨ç½²åˆ°GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
